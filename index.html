<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orange Peel AI Analytics</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }
        .header { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); padding: 24px 32px; display: flex; align-items: center; gap: 16px; }
        .header h1 { font-size: 24px; font-weight: 600; color: white; }
        .header span { font-size: 14px; color: rgba(255,255,255,0.8); }
        .logo { width: 40px; height: 40px; }
        .tabs { display: flex; background: #1e293b; border-bottom: 1px solid #334155; flex-wrap: wrap; }
        .tab { padding: 14px 20px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .tab:hover { background: #334155; }
        .tab.active { border-bottom-color: #f97316; background: #334155; color: #f97316; }
        .content { padding: 32px; max-width: 1400px; margin: 0 auto; }
        .panel { display: none; }
        .panel.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
        .stat-card { background: #1e293b; border-radius: 12px; padding: 20px; border: 1px solid #334155; }
        .stat-label { font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 26px; font-weight: 700; margin-top: 4px; }
        .stat-value.positive { color: #22c55e; }
        .stat-value.negative { color: #ef4444; }
        .stat-value.warning { color: #f59e0b; }
        .stat-value.info { color: #3b82f6; }
        .chart-container { background: #1e293b; border-radius: 12px; padding: 24px; margin-bottom: 24px; border: 1px solid #334155; }
        .chart-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .data-table th { text-align: left; padding: 12px; background: #0f172a; color: #94a3b8; font-weight: 600; text-transform: uppercase; font-size: 11px; }
        .data-table td { padding: 12px; border-bottom: 1px solid #334155; }
        .data-table tr:hover { background: rgba(249, 115, 22, 0.05); }
        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .status-growing { background: rgba(34,197,94,0.2); color: #22c55e; }
        .status-stable { background: rgba(59,130,246,0.2); color: #3b82f6; }
        .status-at-risk { background: rgba(245,158,11,0.2); color: #f59e0b; }
        .status-critical { background: rgba(239,68,68,0.2); color: #ef4444; }
        .health-bar { width: 80px; height: 8px; background: #334155; border-radius: 4px; overflow: hidden; }
        .health-bar-fill { height: 100%; border-radius: 4px; }
        .insight-card { background: linear-gradient(135deg, rgba(249,115,22,0.1) 0%, rgba(234,88,12,0.05) 100%); border: 1px solid rgba(249,115,22,0.3); border-radius: 12px; padding: 20px; margin-top: 24px; }
        .insight-card h4 { color: #f97316; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        @media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }
        .pair-card { background: #0f172a; border-radius: 8px; padding: 16px; display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .pair-icon { font-size: 24px; }
        .pair-details { flex: 1; }
        .pair-title { font-weight: 600; font-size: 14px; }
        .pair-meta { font-size: 12px; color: #94a3b8; margin-top: 4px; }
        .pair-count { font-size: 20px; font-weight: 700; color: #f97316; }
        .rank-badge { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; }
        .rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; }
        .rank-2 { background: linear-gradient(135deg, #d1d5db, #9ca3af); color: #000; }
        .rank-3 { background: linear-gradient(135deg, #d97706, #b45309); color: #fff; }
        .rank-other { background: #334155; color: #94a3b8; }
        .brand-name { font-size: 12px; max-width: 280px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .account-name { max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .nlq-container { max-width: 800px; margin: 0 auto; }
        .nlq-input-group { display: flex; gap: 12px; margin-bottom: 20px; }
        .nlq-input { flex: 1; padding: 16px 20px; border-radius: 12px; border: 1px solid #334155; background: #1e293b; color: #e2e8f0; font-size: 16px; }
        .nlq-input:focus { outline: none; border-color: #f97316; }
        .nlq-button { padding: 16px 32px; border-radius: 12px; border: none; background: #f97316; color: white; font-weight: 600; cursor: pointer; font-size: 16px; }
        .nlq-button:hover { background: #ea580c; }
        .nlq-suggestions { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; }
        .nlq-suggestion { padding: 8px 16px; border-radius: 20px; background: #1e293b; border: 1px solid #334155; cursor: pointer; font-size: 13px; }
        .nlq-suggestion:hover { border-color: #f97316; color: #f97316; }
        .nlq-response { background: #1e293b; border-radius: 12px; padding: 24px; border: 1px solid #334155; }
        .nlq-response-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; font-size: 16px; }
        .sub-label { font-size: 10px; color: #64748b; margin-top: 2px; }
    </style>
</head>
<body>
    <div class="header">
        <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <circle cx="50" cy="50" r="45" fill="#f97316"/>
            <ellipse cx="50" cy="50" rx="35" ry="40" fill="#fb923c"/>
            <path d="M50 5 Q55 15 50 20 Q45 15 50 5" fill="#22c55e"/>
        </svg>
        <div>
            <h1>Orange Peel AI Analytics</h1>
            <span id="header-stats"></span>
        </div>
    </div>
    
    <div class="tabs">
        <div class="tab active" onclick="showPanel('anomaly')">üîç Anomalies</div>
        <div class="tab" onclick="showPanel('forecast')">üìà Forecast</div>
        <div class="tab" onclick="showPanel('accounts')">üè¢ Account Health</div>
        <div class="tab" onclick="showPanel('reps')">üë§ Rep Performance</div>
        <div class="tab" onclick="showPanel('products')">üì¶ Product Mix</div>
        <div class="tab" onclick="showPanel('nlq')">üí¨ Ask AI</div>
    </div>
    
    <div class="content">
        <!-- ANOMALY PANEL -->
        <div id="anomaly-panel" class="panel active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Daily Anomalies</div>
                    <div class="stat-value warning" id="daily-anomaly-count"></div>
                    <div class="sub-label">Significant daily deviations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Supplier Anomalies</div>
                    <div class="stat-value info" id="supplier-anomaly-count"></div>
                    <div class="sub-label">Individual supplier spikes/drops</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Most Volatile</div>
                    <div class="stat-value" style="font-size:16px;color:#f97316;" id="most-volatile"></div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Daily Sales with Anomaly Detection (Z-Score ¬±2œÉ)</div>
                <div id="anomaly-chart"></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">üö® Supplier-Level Anomalies (Spikes/Drops by Individual Supplier)</div>
                <div id="anomaly-list"></div>
            </div>
            <div class="insight-card">
                <h4>ü§ñ AI Insight</h4>
                <p id="anomaly-insight"></p>
            </div>
        </div>
        
        <!-- FORECAST PANEL -->
        <div id="forecast-panel" class="panel">
            <div class="stats-grid" id="forecast-stats"></div>
            <div class="chart-container">
                <div class="chart-title">Sales Forecast with Confidence Intervals</div>
                <div id="forecast-chart"></div>
            </div>
            <div class="two-col">
                <div class="chart-container">
                    <div class="chart-title">Weekly Seasonality</div>
                    <div id="seasonal-chart"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Monthly Trend</div>
                    <div id="monthly-chart"></div>
                </div>
            </div>
            <div class="insight-card">
                <h4>ü§ñ AI Forecast Insight</h4>
                <p id="forecast-insight"></p>
            </div>
        </div>
        
        <!-- ACCOUNTS PANEL -->
        <div id="accounts-panel" class="panel">
            <div class="stats-grid" id="account-stats"></div>
            <div class="two-col">
                <div class="chart-container">
                    <div class="chart-title">Account Health Distribution</div>
                    <div id="health-chart"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Revenue at Risk vs Growing</div>
                    <div id="risk-chart"></div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">‚ö†Ô∏è Priority At-Risk Accounts</div>
                <table class="data-table">
                    <thead><tr><th>Account Name</th><th>Sales</th><th>Trend</th><th>Health</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody id="at-risk-table"></tbody>
                </table>
            </div>
            <div class="chart-container">
                <div class="chart-title">üöÄ Top Growing Accounts</div>
                <table class="data-table">
                    <thead><tr><th>Account Name</th><th>Sales</th><th>Growth</th><th>Health</th><th>Status</th></tr></thead>
                    <tbody id="growing-table"></tbody>
                </table>
            </div>
            <div class="insight-card">
                <h4>ü§ñ AI Account Insights</h4>
                <p id="account-insight"></p>
            </div>
        </div>
        
        <!-- REPS PANEL -->
        <div id="reps-panel" class="panel">
            <div class="stats-grid" id="rep-stats"></div>
            <div class="two-col">
                <div class="chart-container">
                    <div class="chart-title">Top 10 Reps by Sales</div>
                    <div id="rep-chart"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Rep Efficiency (Sales per Account)</div>
                    <div id="rep-efficiency-chart"></div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">üèÜ Rep Performance Leaderboard</div>
                <table class="data-table">
                    <thead><tr><th>Rank</th><th>Rep Name</th><th>Total Sales</th><th>Accounts</th><th>Avg/Account</th><th>Transactions</th><th>Avg/Tx</th></tr></thead>
                    <tbody id="rep-table"></tbody>
                </table>
            </div>
            <div class="insight-card">
                <h4>ü§ñ AI Rep Insights</h4>
                <p id="rep-insight"></p>
            </div>
        </div>
        
        <!-- PRODUCTS PANEL -->
        <div id="products-panel" class="panel">
            <div class="two-col">
                <div class="chart-container">
                    <div class="chart-title">Top Suppliers by Sales</div>
                    <div id="supplier-chart"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Channel Mix</div>
                    <div id="channel-chart"></div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">üèÜ Top Brands/SKUs by Sales</div>
                <table class="data-table">
                    <thead><tr><th>Rank</th><th>Brand/SKU Name</th><th>Supplier</th><th>Sales</th><th>Cases</th><th>Accounts</th></tr></thead>
                    <tbody id="brand-table"></tbody>
                </table>
            </div>
            <div class="two-col">
                <div class="chart-container">
                    <div class="chart-title">üîó Frequently Bought Together</div>
                    <div id="pairs-container"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">üìà Fastest Growing Suppliers</div>
                    <div id="growth-container"></div>
                </div>
            </div>
            <div class="insight-card">
                <h4>ü§ñ AI Product Insights</h4>
                <p id="product-insight"></p>
            </div>
        </div>
        
        <!-- ASK AI PANEL -->
        <div id="nlq-panel" class="panel">
            <div class="nlq-container">
                <h3 style="margin-bottom: 16px;">Ask questions about your sales data</h3>
                <div class="nlq-input-group">
                    <input type="text" class="nlq-input" id="nlq-query" placeholder="e.g., Which accounts are at risk?" onkeypress="if(event.key==='Enter')askQuestion()">
                    <button class="nlq-button" onclick="askQuestion()">Ask AI</button>
                </div>
                <div class="nlq-suggestions">
                    <span class="nlq-suggestion" onclick="setQuery('Which accounts are at risk?')">At-risk accounts?</span>
                    <span class="nlq-suggestion" onclick="setQuery('Who is my top rep?')">Top rep?</span>
                    <span class="nlq-suggestion" onclick="setQuery('Top 5 suppliers by sales')">Top suppliers?</span>
                    <span class="nlq-suggestion" onclick="setQuery('What products sell together?')">Products sold together?</span>
                    <span class="nlq-suggestion" onclick="setQuery('Show top brands')">Top brands?</span>
                    <span class="nlq-suggestion" onclick="setQuery('Which rep has best efficiency?')">Most efficient rep?</span>
                </div>
                <div id="nlq-result" class="nlq-response" style="display: none;">
                    <div class="nlq-response-header">
                        <div style="font-size:24px;">ü§ñ</div>
                        <strong>AI Response</strong>
                    </div>
                    <div id="nlq-answer"></div>
                    <div id="nlq-chart" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const DATA = {"stats": {"total_records": 297160, "total_sales": 15338086.0, "date_min": "2025-10-01", "date_max": "2026-01-27", "suppliers": 32, "accounts": 283, "accounts_analyzed": 191, "reps": 50}, "anomaly": {"daily": [{"date": "2025-10-01", "sales": 285228.8, "is_anomaly": false}, {"date": "2025-10-02", "sales": 138706.8, "is_anomaly": false}, {"date": "2025-10-03", "sales": 217500.0, "is_anomaly": false}, {"date": "2025-10-06", "sales": -10193.2, "is_anomaly": false}, {"date": "2025-10-07", "sales": 131087.2, "is_anomaly": false}, {"date": "2025-10-08", "sales": 205178.0, "is_anomaly": false}, {"date": "2025-10-09", "sales": 234929.6, "is_anomaly": false}, {"date": "2025-10-10", "sales": 236621.6, "is_anomaly": false}, {"date": "2025-10-13", "sales": 8796.0, "is_anomaly": false}, {"date": "2025-10-14", "sales": 184177.6, "is_anomaly": false}, {"date": "2025-10-15", "sales": 177449.6, "is_anomaly": false}, {"date": "2025-10-16", "sales": 210224.8, "is_anomaly": false}, {"date": "2025-10-17", "sales": 188838.8, "is_anomaly": false}, {"date": "2025-10-20", "sales": -5360.4, "is_anomaly": false}, {"date": "2025-10-21", "sales": 107939.2, "is_anomaly": false}, {"date": "2025-10-22", "sales": 383482.4, "is_anomaly": false}, {"date": "2025-10-23", "sales": 134584.4, "is_anomaly": false}, {"date": "2025-10-24", "sales": 217468.4, "is_anomaly": false}, {"date": "2025-10-28", "sales": 190204.0, "is_anomaly": false}, {"date": "2025-10-29", "sales": 366412.4, "is_anomaly": false}, {"date": "2025-10-30", "sales": 239988.8, "is_anomaly": false}, {"date": "2025-10-31", "sales": 115040.4, "is_anomaly": false}, {"date": "2025-11-03", "sales": 66800.0, "is_anomaly": false}, {"date": "2025-11-04", "sales": 133192.4, "is_anomaly": false}, {"date": "2025-11-05", "sales": 458958.0, "is_anomaly": false}, {"date": "2025-11-06", "sales": 171074.4, "is_anomaly": false}, {"date": "2025-11-07", "sales": 215857.2, "is_anomaly": false}, {"date": "2025-11-10", "sales": 0.0, "is_anomaly": false}, {"date": "2025-11-11", "sales": 224474.8, "is_anomaly": false}, {"date": "2025-11-12", "sales": 320982.4, "is_anomaly": false}, {"date": "2025-11-13", "sales": 129588.0, "is_anomaly": false}, {"date": "2025-11-14", "sales": 301024.4, "is_anomaly": false}, {"date": "2025-11-17", "sales": -4174.4, "is_anomaly": false}, {"date": "2025-11-18", "sales": 202920.8, "is_anomaly": false}, {"date": "2025-11-19", "sales": 739471.6, "is_anomaly": true}, {"date": "2025-11-20", "sales": 385784.8, "is_anomaly": false}, {"date": "2025-11-21", "sales": 262144.0, "is_anomaly": false}, {"date": "2025-11-22", "sales": 9866.8, "is_anomaly": false}, {"date": "2025-11-24", "sales": 232090.4, "is_anomaly": false}, {"date": "2025-11-25", "sales": 213647.2, "is_anomaly": false}, {"date": "2025-11-26", "sales": 203500.4, "is_anomaly": false}, {"date": "2025-12-01", "sales": 0.0, "is_anomaly": false}, {"date": "2025-12-02", "sales": 202599.2, "is_anomaly": false}, {"date": "2025-12-03", "sales": 481527.6, "is_anomaly": false}, {"date": "2025-12-04", "sales": 214228.0, "is_anomaly": false}, {"date": "2025-12-05", "sales": 341796.4, "is_anomaly": false}, {"date": "2025-12-08", "sales": -1129.6, "is_anomaly": false}, {"date": "2025-12-09", "sales": 91630.4, "is_anomaly": false}, {"date": "2025-12-10", "sales": 380898.4, "is_anomaly": false}, {"date": "2025-12-11", "sales": 207514.4, "is_anomaly": false}, {"date": "2025-12-12", "sales": 178191.6, "is_anomaly": false}, {"date": "2025-12-15", "sales": 2638.4, "is_anomaly": false}, {"date": "2025-12-16", "sales": 214241.6, "is_anomaly": false}, {"date": "2025-12-17", "sales": 543182.0, "is_anomaly": false}, {"date": "2025-12-18", "sales": 341172.0, "is_anomaly": false}, {"date": "2025-12-19", "sales": 527384.0, "is_anomaly": false}, {"date": "2025-12-22", "sales": 209196.4, "is_anomaly": false}, {"date": "2025-12-23", "sales": 334737.6, "is_anomaly": false}, {"date": "2025-12-24", "sales": 87555.2, "is_anomaly": false}, {"date": "2025-12-29", "sales": 117550.8, "is_anomaly": false}, {"date": "2025-12-30", "sales": 277487.6, "is_anomaly": false}, {"date": "2025-12-31", "sales": 209759.6, "is_anomaly": false}, {"date": "2026-01-02", "sales": 14520.0, "is_anomaly": false}, {"date": "2026-01-05", "sales": 31706.8, "is_anomaly": false}, {"date": "2026-01-06", "sales": 126465.2, "is_anomaly": false}, {"date": "2026-01-07", "sales": 207193.6, "is_anomaly": false}, {"date": "2026-01-08", "sales": 92220.4, "is_anomaly": false}, {"date": "2026-01-09", "sales": 96731.2, "is_anomaly": false}, {"date": "2026-01-12", "sales": -8112.0, "is_anomaly": false}, {"date": "2026-01-13", "sales": 144997.6, "is_anomaly": false}, {"date": "2026-01-14", "sales": 242494.8, "is_anomaly": false}, {"date": "2026-01-15", "sales": 206280.0, "is_anomaly": false}, {"date": "2026-01-16", "sales": 282134.0, "is_anomaly": false}, {"date": "2026-01-19", "sales": 6200.0, "is_anomaly": false}, {"date": "2026-01-20", "sales": 125614.0, "is_anomaly": false}, {"date": "2026-01-21", "sales": 246390.4, "is_anomaly": false}, {"date": "2026-01-22", "sales": 154800.0, "is_anomaly": false}, {"date": "2026-01-23", "sales": 148450.4, "is_anomaly": false}, {"date": "2026-01-27", "sales": 32329.6, "is_anomaly": false}], "supplier_anomalies": [{"date": "2025-12-03", "supplier": "Exhibit-A", "sales": 49808.0, "avg": 11798.46, "z_score": 2.24, "type": "spike"}, {"date": "2025-11-19", "supplier": "Tri-Vin", "sales": 129892.0, "avg": 28007.43, "z_score": 2.22, "type": "spike"}, {"date": "2025-10-29", "supplier": "Citizen Cider", "sales": 43080.0, "avg": 11260.86, "z_score": 2.21, "type": "spike"}, {"date": "2026-01-23", "supplier": "Stormalong Cider", "sales": 35700.0, "avg": 13073.83, "z_score": 2.21, "type": "spike"}, {"date": "2025-11-19", "supplier": "Mighty Squirrel", "sales": 253838.8, "avg": 83310.69, "z_score": 2.19, "type": "spike"}, {"date": "2025-11-19", "supplier": "Citizen Cider", "sales": 41240.0, "avg": 9213.83, "z_score": 2.19, "type": "spike"}, {"date": "2025-11-05", "supplier": "D&V International ", "sales": 15640.0, "avg": 6085.71, "z_score": 2.18, "type": "spike"}, {"date": "2025-11-21", "supplier": "Omnium Brewing", "sales": 11812.0, "avg": 4093.43, "z_score": 2.17, "type": "spike"}, {"date": "2026-01-16", "supplier": "Zero Gravity ", "sales": 139552.0, "avg": 38316.51, "z_score": 2.16, "type": "spike"}, {"date": "2025-12-03", "supplier": "Mighty Squirrel", "sales": 150216.8, "avg": 59683.2, "z_score": 2.15, "type": "spike"}, {"date": "2026-01-14", "supplier": "Lord Hobo", "sales": 77625.2, "avg": 18100.0, "z_score": 2.15, "type": "spike"}, {"date": "2025-12-23", "supplier": "Fabrizia", "sales": 67786.8, "avg": 18784.97, "z_score": 2.15, "type": "spike"}, {"date": "2025-12-23", "supplier": "Artisanal Imports", "sales": 13500.0, "avg": 2817.83, "z_score": 2.14, "type": "spike"}, {"date": "2025-12-30", "supplier": "Skurnik Wines", "sales": 10720.0, "avg": 4374.29, "z_score": 2.13, "type": "spike"}, {"date": "2026-01-14", "supplier": "Press", "sales": 10374.0, "avg": 3521.43, "z_score": 2.11, "type": "spike"}], "stats": {"daily_total": 1, "daily_spikes": 1, "daily_drops": 0, "supplier_total": 28, "supplier_spikes": 28, "supplier_drops": 0, "most_volatile": "Ace Cider"}}, "accounts": {"distribution": {"Stable": 155, "At Risk": 32, "Growing": 4}, "at_risk": [{"account_id": 12652, "account_name": "UNCLE CHEUNG'S RESTAURANT", "total_sales": 727064.0, "trend_pct": -74.3, "health_score": 25.0, "status": "At Risk"}, {"account_id": 13905, "account_name": "JERRY'S LIQUOR MART", "total_sales": 700788.8, "trend_pct": -31.0, "health_score": 34.0, "status": "At Risk"}, {"account_id": 12040, "account_name": "CORK & CASK", "total_sales": 684807.2, "trend_pct": -50.6, "health_score": 25.0, "status": "At Risk"}, {"account_id": 11995, "account_name": "CONCORD PROVISION", "total_sales": 317038.8, "trend_pct": -39.5, "health_score": 30.0, "status": "At Risk"}, {"account_id": 14865, "account_name": "ZZZZZZZZMARTY'S OF DUDLEY", "total_sales": 260063.2, "trend_pct": -27.1, "health_score": 36.0, "status": "At Risk"}, {"account_id": 13070, "account_name": "FRESH POND MARKET", "total_sales": 238305.6, "trend_pct": -24.1, "health_score": 38.0, "status": "At Risk"}, {"account_id": 11491, "account_name": "ZZZCAPE ANN LIQUORS", "total_sales": 205112.0, "trend_pct": -41.8, "health_score": 29.0, "status": "At Risk"}, {"account_id": 12580, "account_name": "EAST MILTON PACKAGE", "total_sales": 162638.4, "trend_pct": -34.3, "health_score": 33.0, "status": "At Risk"}, {"account_id": 13486, "account_name": "HARRY'S BAR & GRILL", "total_sales": 152963.2, "trend_pct": -20.3, "health_score": 40.0, "status": "At Risk"}, {"account_id": 15039, "account_name": "MICHAEL'S CIGAR BAR", "total_sales": 150421.2, "trend_pct": -65.8, "health_score": 25.0, "status": "At Risk"}], "growing": [{"account_id": 11444, "account_name": "THE BOATHOUSE", "total_sales": 206473.6, "trend_pct": 76.6, "health_score": 75.0, "status": "Growing"}, {"account_id": 12845, "account_name": "FERNANDEZ CHELSEA", "total_sales": 171773.2, "trend_pct": 84.0, "health_score": 75.0, "status": "Growing"}, {"account_id": 13225, "account_name": "GORDONS MAIN-WINE", "total_sales": 91904.8, "trend_pct": 88.8, "health_score": 75.0, "status": "Growing"}, {"account_id": 14039, "account_name": "KAPPY'S (CHICOPEE)", "total_sales": 78314.8, "trend_pct": 56.7, "health_score": 75.0, "status": "Growing"}], "total": 191, "at_risk_count": 32, "at_risk_pct": 16.8}, "reps": {"reps": [{"rep_id": 220, "rep_name": "Joseph Sullivan", "total_sales": 998560.0, "unique_accounts": 5, "avg_per_account": 199712.0, "transaction_count": 17680, "avg_per_tx": 56.48}, {"rep_id": 231, "rep_name": "Lauren Hurton", "total_sales": 925544.0, "unique_accounts": 9, "avg_per_account": 102838.22, "transaction_count": 8680, "avg_per_tx": 106.63}, {"rep_id": 43, "rep_name": "Derek Adelino", "total_sales": 741693.2, "unique_accounts": 9, "avg_per_account": 82410.36, "transaction_count": 16080, "avg_per_tx": 46.13}, {"rep_id": 54, "rep_name": "Brenden Groom", "total_sales": 727064.0, "unique_accounts": 1, "avg_per_account": 727064.0, "transaction_count": 7560, "avg_per_tx": 96.17}, {"rep_id": 248, "rep_name": "Otis Alkevicius", "total_sales": 724817.6, "unique_accounts": 13, "avg_per_account": 55755.2, "transaction_count": 15080, "avg_per_tx": 48.06}, {"rep_id": 152, "rep_name": "Chris Walsh", "total_sales": 707206.4, "unique_accounts": 14, "avg_per_account": 50514.74, "transaction_count": 11560, "avg_per_tx": 61.18}, {"rep_id": 201, "rep_name": "Nate Lavigne", "total_sales": 627873.6, "unique_accounts": 13, "avg_per_account": 48297.97, "transaction_count": 10960, "avg_per_tx": 57.29}, {"rep_id": 63, "rep_name": "Will Feuersanger", "total_sales": 607781.6, "unique_accounts": 14, "avg_per_account": 43412.97, "transaction_count": 13720, "avg_per_tx": 44.3}, {"rep_id": 159, "rep_name": "Lexi Anastos", "total_sales": 523554.0, "unique_accounts": 6, "avg_per_account": 87259.0, "transaction_count": 9720, "avg_per_tx": 53.86}, {"rep_id": 237, "rep_name": "Nathan Palmquist", "total_sales": 504848.4, "unique_accounts": 8, "avg_per_account": 63106.05, "transaction_count": 12240, "avg_per_tx": 41.25}], "total": 50, "avg_sales": 306761.72, "total_accounts": 283}, "products": {"top_suppliers": [{"name": "Mighty Squirrel", "sales": 3549404.0, "accounts": 224}, {"name": "Zero Gravity ", "sales": 2564576.8, "accounts": 180}, {"name": "Lord Hobo", "sales": 2168352.0, "accounts": 177}, {"name": "Stormalong Cider", "sales": 1082556.8, "accounts": 111}, {"name": "Tri-Vin", "sales": 1046130.8, "accounts": 57}, {"name": "Exhibit-A", "sales": 725502.8, "accounts": 103}, {"name": "Citizen Cider", "sales": 613202.8, "accounts": 91}, {"name": "Fabrizia", "sales": 486221.2, "accounts": 48}, {"name": "Medusa Brewing", "sales": 402777.2, "accounts": 81}, {"name": "Stoneface Brewing", "sales": 357453.6, "accounts": 73}], "top_brands": [{"supplier": "Mighty Squirrel", "brand_name": "6/4/16 MIGHTY SQUIREL CLOUD CANDY CA", "sales": 1758557.6, "cases": 49582.1, "accounts": 161}, {"supplier": "Lord Hobo", "brand_name": "6/4/16 LORD HOBO BOOMSAUCE IPA", "sales": 604707.2, "cases": 15475.52, "accounts": 110}, {"supplier": "Mighty Squirrel", "brand_name": "MIGHTY SQUIREL CLOUD CAND 50L", "sales": 559375.2, "cases": 26769.43, "accounts": 32}, {"supplier": "Zero Gravity ", "brand_name": "6/4/16 ZERO GRAVITY CONEHEAD", "sales": 375186.8, "cases": 13164.41, "accounts": 93}, {"supplier": "Stormalong Cider", "brand_name": "6/4/16 STORMALONG HAP HOLIDAY CAN", "sales": 288716.8, "cases": 9057.76, "accounts": 65}, {"supplier": "Zero Gravity ", "brand_name": "2/12PK ZERO GRAVITY MORE 4 DOLLAR", "sales": 267200.0, "cases": 16000.0, "accounts": 1}, {"supplier": "Exhibit-A", "brand_name": "6/4/16 EXHIBIT A CATS MEOW IPA", "sales": 267185.2, "cases": 7277.76, "accounts": 75}, {"supplier": "Stormalong Cider", "brand_name": "6/4/16 STORMALONG LEGENDARY CAN", "sales": 255000.0, "cases": 7999.98, "accounts": 64}, {"supplier": "Citizen Cider", "brand_name": "6/4/16 CITIZEN CIDER UNIFIED PRS CAN", "sales": 227126.8, "cases": 6977.76, "accounts": 60}, {"supplier": "Zero Gravity ", "brand_name": "2/12PK ZERO GRAVITY VARIETY PACK", "sales": 224754.8, "cases": 11380.0, "accounts": 49}], "supplier_pairs": [{"s1": "Mighty Squirrel", "s2": "Zero Gravity ", "count": 393}, {"s1": "Lord Hobo", "s2": "Mighty Squirrel", "count": 360}, {"s1": "Lord Hobo", "s2": "Zero Gravity ", "count": 316}, {"s1": "Mighty Squirrel", "s2": "Stormalong Cider", "count": 168}, {"s1": "Exhibit-A", "s2": "Mighty Squirrel", "count": 153}, {"s1": "Stormalong Cider", "s2": "Zero Gravity ", "count": 153}, {"s1": "Exhibit-A", "s2": "Zero Gravity ", "count": 145}, {"s1": "Lord Hobo", "s2": "Stormalong Cider", "count": 135}, {"s1": "Citizen Cider", "s2": "Zero Gravity ", "count": 125}, {"s1": "Citizen Cider", "s2": "Mighty Squirrel", "count": 120}], "channels": [{"name": "Off-Premise", "sales": 3542866.4, "pct": 23.1}, {"name": "On-Premise", "sales": 11795219.6, "pct": 76.9}], "growth": [{"name": "Jiant Kombucha", "pct": 33.3}, {"name": "Fabrizia", "pct": 22.1}, {"name": "Exhibit-A", "pct": 4.5}, {"name": "Glendalough", "pct": 2.2}, {"name": "Lord Hobo", "pct": 0.0}]}, "forecast": {"monthly": {"2025-10": 3958305.2, "2025-11": 4267203.2, "2025-12": 4962161.6, "2026-01": 2150416.0}, "dow": [{"day": "Mon", "full": "Monday", "avg": 45.0}, {"day": "Tue", "full": "Tuesday", "avg": 52.0}, {"day": "Wed", "full": "Wednesday", "avg": 56.0}, {"day": "Thu", "full": "Thursday", "avg": 44.0}, {"day": "Fri", "full": "Friday", "avg": 55.0}, {"day": "Sat", "full": "Saturday", "avg": 82.0}, {"day": "Sun", "full": "Sunday", "avg": 0}], "next_30d": 5401027.0, "growth_pct": -19.4, "daily_avg": 180034.0}};
        
        document.getElementById('header-stats').textContent = 
            `${DATA.stats.total_records.toLocaleString()} transactions ‚Ä¢ ${DATA.stats.suppliers} suppliers ‚Ä¢ ${DATA.stats.accounts} accounts ‚Ä¢ ${DATA.stats.date_min.slice(5).replace('-','/')} - ${DATA.stats.date_max.slice(5).replace('-','/')}`;
        
        function showPanel(panel) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(panel + '-panel').classList.add('active');
            event.target.closest('.tab').classList.add('active');
            renderPanel(panel);
        }
        
        function renderPanel(panel) {
            if (panel === 'anomaly') renderAnomalyPanel();
            if (panel === 'forecast') renderForecastPanel();
            if (panel === 'accounts') renderAccountsPanel();
            if (panel === 'reps') renderRepsPanel();
            if (panel === 'products') renderProductsPanel();
        }
        
        function renderAnomalyPanel() {
            const stats = DATA.anomaly.stats;
            // FIXED: Show both daily and supplier anomaly counts clearly
            document.getElementById('daily-anomaly-count').textContent = stats.daily_total;
            document.getElementById('supplier-anomaly-count').textContent = `${stats.supplier_spikes} spikes, ${stats.supplier_drops} drops`;
            document.getElementById('most-volatile').textContent = stats.most_volatile;
            
            const daily = DATA.anomaly.daily;
            const anomalyPts = daily.filter(d => d.is_anomaly);
            Plotly.newPlot('anomaly-chart', [
                {x: daily.map(d => d.date), y: daily.map(d => d.sales), type: 'scatter', mode: 'lines', line: {color: '#f97316', width: 2}, name: 'Daily Sales'},
                {x: anomalyPts.map(d => d.date), y: anomalyPts.map(d => d.sales), type: 'scatter', mode: 'markers', marker: {color: '#ef4444', size: 14, symbol: 'diamond'}, name: `Daily Anomalies (${anomalyPts.length})`}
            ], {paper_bgcolor: 'transparent', plot_bgcolor: 'transparent', font: {color: '#94a3b8'}, xaxis: {gridcolor: '#334155'}, yaxis: {gridcolor: '#334155', tickformat: '$,.0f'}, legend: {orientation: 'h', y: -0.15}, margin: {t: 20, r: 20}}, {responsive: true});
            
            // Show supplier-level anomalies in list
            const supplierAnomalies = DATA.anomaly.supplier_anomalies;
            if (supplierAnomalies.length === 0) {
                document.getElementById('anomaly-list').innerHTML = '<p style="color:#94a3b8;padding:20px;">No significant supplier-level anomalies detected in this period.</p>';
            } else {
                document.getElementById('anomaly-list').innerHTML = supplierAnomalies.slice(0, 10).map(a => `
                    <div style="display:flex;align-items:center;padding:12px;background:#0f172a;border-radius:8px;margin-bottom:8px;">
                        <span style="font-size:20px;margin-right:12px;">${a.type === 'spike' ? 'üìà' : 'üìâ'}</span>
                        <div style="flex:1;"><strong>${a.supplier}</strong><br><span style="color:#94a3b8;font-size:12px;">${a.date} ‚Ä¢ $${a.sales.toLocaleString()} vs $${Math.round(a.avg).toLocaleString()} avg</span></div>
                        <span style="color:${a.type === 'spike' ? '#22c55e' : '#ef4444'};font-weight:700;">${a.z_score > 0 ? '+' : ''}${a.z_score.toFixed(1)}œÉ</span>
                    </div>
                `).join('');
            }
            
            document.getElementById('anomaly-insight').innerHTML = `
                <strong>Daily Level:</strong> ${stats.daily_total} significant anomaly detected (${stats.daily_spikes} spike, ${stats.daily_drops} drops) - shown on chart.<br><br>
                <strong>Supplier Level:</strong> ${stats.supplier_total} individual supplier anomalies (${stats.supplier_spikes} spikes, ${stats.supplier_drops} drops). <strong>${stats.most_volatile}</strong> shows highest day-to-day volatility. These supplier-level spikes may not show as daily anomalies when other suppliers offset them.
            `;
        }
        
        function renderForecastPanel() {
            document.getElementById('forecast-stats').innerHTML = `
                <div class="stat-card"><div class="stat-label">Next 30 Days (Est.)</div><div class="stat-value positive">$${(DATA.forecast.next_30d/1000000).toFixed(2)}M</div></div>
                <div class="stat-card"><div class="stat-label">Vs Prior Period</div><div class="stat-value ${DATA.forecast.growth_pct >= 0 ? 'positive' : 'negative'}">${DATA.forecast.growth_pct >= 0 ? '+' : ''}${DATA.forecast.growth_pct}%</div></div>
                <div class="stat-card"><div class="stat-label">Daily Average (Recent)</div><div class="stat-value" style="color:#f97316;">$${DATA.forecast.daily_avg.toLocaleString()}</div></div>
            `;
            
            const daily = DATA.anomaly.daily;
            const hist = daily.slice(-60);
            const lastDate = new Date(daily[daily.length-1].date);
            const avgSales = DATA.forecast.daily_avg;
            
            const fcDates = [], fcSales = [], fcUpper = [], fcLower = [];
            for (let i = 1; i <= 30; i++) {
                const d = new Date(lastDate);
                d.setDate(d.getDate() + i);
                fcDates.push(d.toISOString().split('T')[0]);
                const dayOfWeek = d.getDay();
                const seasonalFactor = dayOfWeek === 0 || dayOfWeek === 6 ? 0.3 : 1.0;
                const val = avgSales * seasonalFactor;
                fcSales.push(val);
                fcUpper.push(val * 1.3);
                fcLower.push(val * 0.7);
            }
            
            Plotly.newPlot('forecast-chart', [
                {x: hist.map(d => d.date), y: hist.map(d => d.sales), type: 'scatter', mode: 'lines', line: {color: '#f97316', width: 2}, name: 'Historical'},
                {x: fcDates.concat(fcDates.slice().reverse()), y: fcUpper.concat(fcLower.slice().reverse()), fill: 'toself', fillcolor: 'rgba(34,197,94,0.2)', line: {color: 'transparent'}, name: '90% CI', type: 'scatter'},
                {x: fcDates, y: fcSales, type: 'scatter', mode: 'lines', line: {color: '#22c55e', width: 3, dash: 'dot'}, name: 'Forecast'}
            ], {paper_bgcolor: 'transparent', plot_bgcolor: 'transparent', font: {color: '#94a3b8'}, xaxis: {gridcolor: '#334155'}, yaxis: {gridcolor: '#334155', tickformat: '$,.0f'}, legend: {orientation: 'h', y: -0.15}, margin: {t: 20, r: 20}}, {responsive: true});
            
            const dow = DATA.forecast.dow;
            const avgDow = dow.reduce((a, b) => a + b.avg, 0) / dow.length;
            Plotly.newPlot('seasonal-chart', [{x: dow.map(d => d.day), y: dow.map(d => d.avg), type: 'bar', marker: {color: dow.map(d => d.avg > avgDow ? '#22c55e' : '#ef4444')}}],
                {paper_bgcolor: 'transparent', plot_bgcolor: 'transparent', font: {color: '#94a3b8'}, yaxis: {tickformat: '$,.0f'}, margin: {t: 20, r: 20, l: 60, b: 40}}, {responsive: true});
            
            const monthly = DATA.forecast.monthly;
            const monthLabels = Object.keys(monthly).map(m => {const [y,mo] = m.split('-'); return mo + '/' + y.slice(2);});
            Plotly.newPlot('monthly-chart', [{x: monthLabels, y: Object.values(monthly), type: 'bar', marker: {color: '#f97316'}}],
                {paper_bgcolor: 'transparent', plot_bgcolor: 'transparent', font: {color: '#94a3b8'}, yaxis: {tickformat: '$,.0f'}, margin: {t: 20, r: 20, l: 70, b: 40}}, {responsive: true});
            
            const bestDay = dow.reduce((a, b) => a.avg > b.avg ? a : b);
            const worstDay = dow.reduce((a, b) => a.avg < b.avg ? a : b);
            document.getElementById('forecast-insight').innerHTML = `30-day forecast: <strong>$${(DATA.forecast.next_30d/1000000).toFixed(2)}M</strong>. Strong weekday pattern: <strong>${bestDay.full}</strong> averages $${bestDay.avg.toLocaleString()} while <strong>${worstDay.full}</strong> is lowest. Note: ${DATA.forecast.growth_pct < 0 ? 'Decline' : 'Growth'} of ${Math.abs(DATA.forecast.growth_pct)}% vs prior period may reflect seasonal patterns.`;
        }
        
        function renderAccountsPanel() {
            const dist = DATA.accounts.distribution;
            document.getElementById('account-stats').innerHTML = `
                <div class="stat-card"><div class="stat-label">Accounts Analyzed</div><div class="stat-value info">${DATA.accounts.total}</div><div class="sub-label">With 3+ weeks of data</div></div>
                <div class="stat-card"><div class="stat-label">Growing</div><div class="stat-value positive">${dist.Growing || 0}</div></div>
                <div class="stat-card"><div class="stat-label">Stable</div><div class="stat-value" style="color:#3b82f6;">${dist.Stable || 0}</div></div>
                <div class="stat-card"><div class="stat-label">At Risk</div><div class="stat-value warning">${dist['At Risk'] || 0}</div></div>
                <div class="stat-card"><div class="stat-label">Critical</div><div class="stat-value negative">${dist.Critical || 0}</div></div>
            `;
            
            const colors = [];
            const labels = [];
            if (dist.Growing) { labels.push('Growing'); colors.push('#22c55e'); }
            if (dist.Stable) { labels.push('Stable'); colors.push('#3b82f6'); }
            if (dist['At Risk']) { labels.push('At Risk'); colors.push('#f59e0b'); }
            if (dist.Critical) { labels.push('Critical'); colors.push('#ef4444'); }
            
            Plotly.newPlot('health-chart', [{labels: labels, values: labels.map(l => dist[l] || 0), type: 'pie', marker: {colors: colors}, hole: 0.4}],
                {paper_bgcolor: 'transparent', font: {color: '#94a3b8'}, margin: {t: 20, r: 20, l: 20, b: 20}}, {responsive: true});
            
            const atRiskRev = DATA.accounts.at_risk.reduce((a, b) => a + b.total_sales, 0);
            const growRev = DATA.accounts.growing.reduce((a, b) => a + b.total_sales, 0);
            Plotly.newPlot('risk-chart', [{x: ['At Risk Revenue', 'Growing Revenue'], y: [atRiskRev, growRev], type: 'bar', marker: {color: ['#ef4444', '#22c55e']}}],
                {paper_bgcolor: 'transparent', plot_bgcolor: 'transparent', font: {color: '#94a3b8'}, yaxis: {tickformat: '$,.0f'}, margin: {t: 20, r: 20, l: 70, b: 40}}, {responsive: true});
            
            document.getElementById('at-risk-table').innerHTML = DATA.accounts.at_risk.length ? DATA.accounts.at_risk.map(a => `
                <tr>
                    <td class="account-name" title="${a.account_name}"><strong>${a.account_name}</strong></td>
                    <td>$${a.total_sales.toLocaleString()}</td>
                    <td style="color:#ef4444;">${a.trend_pct.toFixed(1)}%</td>
                    <td><div class="health-bar"><div class="health-bar-fill" style="width:${a.health_score}%;background:${a.health_score < 20 ? '#ef4444' : '#f59e0b'};"></div></div></td>
                    <td><span class="status-badge status-${a.status.toLowerCase().replace(' ', '-')}">${a.status}</span></td>
                    <td><button style="padding:4px 12px;border-radius:6px;border:none;background:#f97316;color:white;cursor:pointer;font-size:11px;">Contact</button></td>
                </tr>
            `).join('') : '<tr><td colspan="6" style="text-align:center;color:#94a3b8;">No at-risk accounts found</td></tr>';
            
            document.getElementById('growing-table').innerHTML = DATA.accounts.growing.length ? DATA.accounts.growing.map(a => `
                <tr>
                    <td class="account-name" title="${a.account_name}"><strong>${a.account_name}</strong></td>
                    <td>$${a.total_sales.toLocaleString()}</td>
                    <td style="color:#22c55e;">+${a.trend_pct.toFixed(1)}%</td>
                    <td><div class="health-bar"><div class="health-bar-fill" style="width:${a.health_score}%;background:#22c55e;"></div></div></td>
                    <td><span class="status-badge status-growing">${a.status}</span></td>
                </tr>
            `).join('') : '<tr><td colspan="5" style="text-align:center;color:#94a3b8;">No growing accounts found</td></tr>';
            
            const topAtRisk = DATA.accounts.at_risk[0];
            document.getElementById('account-insight').innerHTML = `<strong>${DATA.accounts.at_risk_count} accounts (${DATA.accounts.at_risk_pct}%)</strong> are at risk or critical out of ${DATA.accounts.total} analyzed. ${topAtRisk ? `Top priority: <strong>${topAtRisk.account_name}</strong> ($${topAtRisk.total_sales.toLocaleString()}, ${topAtRisk.trend_pct}% trend). Recommend immediate outreach.` : 'All accounts are stable or growing!'}`;
        }
        
        function renderRepsPanel() {
            const reps = DATA.reps.reps;
            const topRep = reps[0] || {};
            
            // Find most efficient rep (highest avg per account with at least 3 accounts)
            const efficientReps = reps.filter(r => r.unique_accounts >= 3);
            const mostEfficient = efficientReps.length ? efficientReps.reduce((a, b) => a.avg_per_account > b.avg_per_account ? a : b) : topRep;
            
            document.getElementById('rep-stats').innerHTML = `
                <div class="stat-card"><div class="stat-label">Total Reps</div><div class="stat-value info">${DATA.reps.total}</div></div>
                <div class="stat-card"><div class="stat-label">Top Rep (by Sales)</div><div class="stat-value" style="font-size:16px;color:#22c55e;">${topRep.rep_name || 'N/A'}</div></div>
                <div class="stat-card"><div class="stat-label">Avg Rep Sales</div><div class="stat-value" style="color:#f97316;">$${(DATA.reps.avg_sales/1000).toFixed(0)}K</div></div>
                <div class="stat-card"><div class="stat-label">Total Accounts</div><div class="stat-value info">${DATA.reps.total_accounts}</div></div>
            `;
            
            Plotly.newPlot('rep-chart', [{x: reps.map(r => r.rep_name), y: reps.map(r => r.total_sales), type: 'bar', marker: {color: reps.map((_, i) => i === 0 ? '#22c55e' : i < 3 ? '#f97316' : '#64748b')}}],
                {paper_bgcolor: 'transparent', plot_bgcolor: 'transparent', font: {color: '#94a3b8'}, xaxis: {tickangle: -45}, yaxis: {tickformat: '$,.0f'}, margin: {t: 20, r: 20, l: 70, b: 120}}, {responsive: true});
            
            Plotly.newPlot('rep-efficiency-chart', [{
                x: reps.map(r => r.unique_accounts),
                y: reps.map(r => r.avg_per_account),
                mode: 'markers+text',
                type: 'scatter',
                marker: {size: reps.map(r => Math.sqrt(r.total_sales) / 18), color: '#f97316'},
                text: reps.map(r => r.rep_name.split(' ')[0]),
                textposition: 'top center',
                textfont: {size: 10}
            }], {paper_bgcolor: 'transparent', plot_bgcolor: 'transparent', font: {color: '#94a3b8'}, xaxis: {gridcolor: '#334155', title: 'Number of Accounts'}, yaxis: {gridcolor: '#334155', title: 'Avg Sales/Account', tickformat: '$,.0f'}, margin: {t: 20, r: 20, l: 80, b: 50}}, {responsive: true});
            
            document.getElementById('rep-table').innerHTML = reps.map((r, i) => `
                <tr>
                    <td><span class="rank-badge rank-${i < 3 ? i + 1 : 'other'}">${i + 1}</span></td>
                    <td><strong>${r.rep_name}</strong></td>
                    <td>$${r.total_sales.toLocaleString()}</td>
                    <td>${r.unique_accounts}</td>
                    <td>$${r.avg_per_account.toLocaleString()}</td>
                    <td>${r.transaction_count.toLocaleString()}</td>
                    <td>$${r.avg_per_tx.toFixed(2)}</td>
                </tr>
            `).join('');
            
            document.getElementById('rep-insight').innerHTML = `<strong>${topRep.rep_name}</strong> leads in total sales with $${topRep.total_sales?.toLocaleString()} across ${topRep.unique_accounts} accounts. <strong>${mostEfficient.rep_name}</strong> has highest efficiency at $${mostEfficient.avg_per_account?.toLocaleString()}/account. Average rep generates <strong>$${(DATA.reps.avg_sales/1000).toFixed(0)}K</strong>.`;
        }
        
        function renderProductsPanel() {
            const suppliers = DATA.products.top_suppliers;
            Plotly.newPlot('supplier-chart', [{x: suppliers.map(s => s.name), y: suppliers.map(s => s.sales), type: 'bar', marker: {color: '#f97316'}}],
                {paper_bgcolor: 'transparent', plot_bgcolor: 'transparent', font: {color: '#94a3b8'}, xaxis: {tickangle: -45}, yaxis: {tickformat: '$,.0f'}, margin: {t: 20, r: 20, l: 70, b: 120}}, {responsive: true});
            
            const channels = DATA.products.channels;
            Plotly.newPlot('channel-chart', [{labels: channels.map(c => `${c.name} (${c.pct}%)`), values: channels.map(c => c.sales), type: 'pie', marker: {colors: ['#f97316', '#3b82f6']}, hole: 0.4}],
                {paper_bgcolor: 'transparent', font: {color: '#94a3b8'}, margin: {t: 20, r: 20, l: 20, b: 20}}, {responsive: true});
            
            document.getElementById('brand-table').innerHTML = DATA.products.top_brands.map((b, i) => `
                <tr>
                    <td><span class="rank-badge rank-${i < 3 ? i + 1 : 'other'}">${i + 1}</span></td>
                    <td class="brand-name" title="${b.brand_name}"><strong>${b.brand_name}</strong></td>
                    <td>${b.supplier}</td>
                    <td>$${b.sales.toLocaleString()}</td>
                    <td>${Math.round(b.cases).toLocaleString()}</td>
                    <td>${b.accounts}</td>
                </tr>
            `).join('');
            
            document.getElementById('pairs-container').innerHTML = DATA.products.supplier_pairs.slice(0, 5).map((p, i) => `
                <div class="pair-card">
                    <div class="pair-icon">${i === 0 ? 'ü•á' : 'üîó'}</div>
                    <div class="pair-details"><div class="pair-title">${p.s1}</div><div class="pair-meta">+ ${p.s2}</div></div>
                    <div class="pair-count">${p.count.toLocaleString()}</div>
                </div>
            `).join('');
            
            document.getElementById('growth-container').innerHTML = DATA.products.growth.length ? DATA.products.growth.map((g, i) => `
                <div class="pair-card">
                    <div class="pair-icon">${i === 0 ? 'üöÄ' : 'üìà'}</div>
                    <div class="pair-details"><div class="pair-title">${g.name}</div></div>
                    <div class="pair-count" style="color: #22c55e;">+${g.pct}%</div>
                </div>
            `).join('') : '<p style="color:#94a3b8;padding:12px;">No significant growth detected</p>';
            
            const topPair = DATA.products.supplier_pairs[0];
            const topBrand = DATA.products.top_brands[0];
            document.getElementById('product-insight').innerHTML = `<strong>${topPair?.s1} + ${topPair?.s2}</strong> are most frequently bought together (${topPair?.count.toLocaleString()} times). <strong>${topBrand?.brand_name}</strong> leads SKU sales at $${topBrand?.sales.toLocaleString()}. Top supplier: <strong>${suppliers[0]?.name}</strong> with $${suppliers[0]?.sales.toLocaleString()}.`;
        }
        
        // NLQ
        function setQuery(q) { document.getElementById('nlq-query').value = q; askQuestion(); }
        
        function askQuestion() {
            const query = document.getElementById('nlq-query').value.toLowerCase();
            const resultDiv = document.getElementById('nlq-result');
            const answerDiv = document.getElementById('nlq-answer');
            const chartDiv = document.getElementById('nlq-chart');
            resultDiv.style.display = 'block';
            chartDiv.innerHTML = '';
            
            if (query.includes('at risk') || query.includes('at-risk')) {
                const atRisk = DATA.accounts.at_risk.slice(0, 5);
                answerDiv.innerHTML = `<p><strong>${DATA.accounts.at_risk_count} accounts (${DATA.accounts.at_risk_pct}%)</strong> are currently at risk:</p>
                    <ol style="margin:12px 0 0 20px;line-height:2;">${atRisk.map(a => `<li><strong>${a.account_name}</strong> ‚Äî $${a.total_sales.toLocaleString()} (${a.trend_pct}% trend)</li>`).join('')}</ol>`;
            } else if (query.includes('top rep') || query.includes('best rep')) {
                const top = DATA.reps.reps[0];
                answerDiv.innerHTML = `<p><strong>Top Rep by Total Sales:</strong></p>
                    <p style="margin-top:12px;font-size:24px;font-weight:700;color:#22c55e;">${top.rep_name}</p>
                    <p>Total Sales: <strong>$${top.total_sales.toLocaleString()}</strong></p>
                    <p>Accounts: <strong>${top.unique_accounts}</strong> | Avg/Account: <strong>$${top.avg_per_account.toLocaleString()}</strong></p>`;
            } else if (query.includes('efficient') || query.includes('efficiency')) {
                const efficientReps = DATA.reps.reps.filter(r => r.unique_accounts >= 2).sort((a,b) => b.avg_per_account - a.avg_per_account);
                const top = efficientReps[0];
                answerDiv.innerHTML = `<p><strong>Most Efficient Rep (Sales per Account):</strong></p>
                    <p style="margin-top:12px;font-size:24px;font-weight:700;color:#22c55e;">${top.rep_name}</p>
                    <p>Avg/Account: <strong>$${top.avg_per_account.toLocaleString()}</strong></p>
                    <p>Total Sales: <strong>$${top.total_sales.toLocaleString()}</strong> across ${top.unique_accounts} accounts</p>`;
            } else if (query.includes('supplier')) {
                const suppliers = DATA.products.top_suppliers.slice(0, 5);
                answerDiv.innerHTML = `<p><strong>Top 5 Suppliers:</strong></p>
                    <ol style="margin:12px 0 0 20px;line-height:2;">${suppliers.map(s => `<li><strong>${s.name}</strong> ‚Äî $${s.sales.toLocaleString()}</li>`).join('')}</ol>`;
            } else if (query.includes('together') || query.includes('pair')) {
                const pairs = DATA.products.supplier_pairs.slice(0, 5);
                answerDiv.innerHTML = `<p><strong>Products Bought Together:</strong></p>
                    <ol style="margin:12px 0 0 20px;line-height:2;">${pairs.map(p => `<li>${p.s1} + ${p.s2} ‚Äî ${p.count.toLocaleString()} times</li>`).join('')}</ol>`;
            } else if (query.includes('brand')) {
                const brands = DATA.products.top_brands.slice(0, 5);
                answerDiv.innerHTML = `<p><strong>Top Brands/SKUs:</strong></p>
                    <ol style="margin:12px 0 0 20px;line-height:2;">${brands.map(b => `<li><strong>${b.brand_name}</strong> (${b.supplier}) ‚Äî $${b.sales.toLocaleString()}</li>`).join('')}</ol>`;
            } else {
                answerDiv.innerHTML = `<p>Try asking about: at-risk accounts, top rep, most efficient rep, top suppliers, products bought together, or top brands.</p>`;
            }
        }
        
        renderAnomalyPanel();
    </script>
</body>
</html>